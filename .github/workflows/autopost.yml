# name: Bondalayze Auto Blog Post

# on:
#   schedule:
#     - cron: "0 */6 * * *" # প্রতি 6 ঘন্টা
#   workflow_dispatch:

# jobs:
#   autopost:
#     runs-on: ubuntu-latest
#     timeout-minutes: 20

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#           cache: "npm"

#       - name: Install deps
#         run: npm ci

#       - name: Run autopost
#         run: npm run autopost
#         env:
#           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#           OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

#           # Supabase (fallback works with either SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL)
#           SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
#           NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
#           SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

#       - name: Trigger social share (FB + IG + Pinterest)
#         run: |
#           curl -fsSL "${{ secrets.SITE_URL }}/api/autopost/social?key=${{ secrets.CRON_SECRET }}"

name: Bondalayze Auto Blog Post

on:
  schedule:
    - cron: "0 */6 * * *" # প্রতি 6 ঘন্টা
  workflow_dispatch:

concurrency:
  group: bondalayze-autopost
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  autopost:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run autopost
        run: npm run autopost
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_IMAGE_MODEL: ${{ secrets.OPENAI_IMAGE_MODEL }}

          # Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          # Optional blog limits (if you use these in code)
          MAX_POSTS_PER_24H: ${{ secrets.MAX_POSTS_PER_24H }}
          MIN_HOURS_BETWEEN_POSTS: ${{ secrets.MIN_HOURS_BETWEEN_POSTS }}
          BLOG_DEFAULT_COVER_URL: ${{ secrets.BLOG_DEFAULT_COVER_URL }}

      - name: Trigger social share (FB + IG + Pinterest)
        if: success()
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$SITE_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "Missing SITE_URL or CRON_SECRET in GitHub Secrets"
            exit 1
          fi

          URL="${SITE_URL%/}/api/autopost/social?key=${CRON_SECRET}"
          echo "Calling: $URL"

          curl --fail --show-error --silent \
            --connect-timeout 10 \
            --max-time 60 \
            --retry 3 \
            --retry-delay 5 \
            "$URL"

          echo "✅ Social share trigger done"
